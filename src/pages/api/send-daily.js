import axios from 'axios';
import { getSubscribers } from '../../utils/dataStorage.js';
import { sendDailyHadithToAll } from '../../utils/emailSender.js';

export default async function handler(req, res) {
  // ÙÙ‚Ø· POST requests
  if (req.method !== 'POST') {
    return res.status(405).json({ 
      ok: false, 
      message: 'Method not allowed' 
    });
  }

  try {
    console.log('ğŸ“– Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ÙŠ...');

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
    const subscribers = await getSubscribers();
    
    if (subscribers.length === 0) {
      return res.status(200).json({ 
        ok: true, 
        message: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹',
        stats: { total: 0, successful: 0, failed: 0 }
      });
    }

    console.log(`ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†: ${subscribers.length}`);

    // Ø¬Ù„Ø¨ Ø­Ø¯ÙŠØ« Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† API Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«
    let hadith;
    try {
      console.log('ğŸ” Ø¬Ù„Ø¨ Ø­Ø¯ÙŠØ« Ù…Ù† API...');
      
      // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ ÙˆÙ…Ø³Ù„Ù…
      const books = ['bukhari', 'muslim'];
      const randomBook = books[Math.floor(Math.random() * books.length)];
      
      const hadithResponse = await axios.get('https://hadithapi.com/public/api/hadiths', {
        params: {
          apiKey: process.env.HADITH_API_KEY,
          book: randomBook,
          random: 1
        },
        timeout: 10000 // 10 seconds timeout
      });

      if (!hadithResponse.data || !hadithResponse.data.hadiths || hadithResponse.data.hadiths.length === 0) {
        throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø­Ø§Ø¯ÙŠØ« Ù…Ù† API');
      }

      hadith = hadithResponse.data.hadiths[0];
      console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ù…Ù†:', randomBook);
      console.log('ğŸ“„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¯ÙŠØ«:', hadith.hadithText?.substring(0, 100) + '...');

    } catch (apiError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ÙŠØ« Ù…Ù† API:', apiError.message);
      
      // Ø­Ø¯ÙŠØ« Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ API
      hadith = {
        hadithText: 'Ø¹Ù† Ø£Ø¨ÙŠ Ù‡Ø±ÙŠØ±Ø© Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡ Ù‚Ø§Ù„: Ù‚Ø§Ù„ Ø±Ø³ÙˆÙ„ Ø§Ù„Ù„Ù‡ ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ³Ù„Ù…: "ÙƒÙ„Ù…ØªØ§Ù† Ø®ÙÙŠÙØªØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø³Ø§Ù†ØŒ Ø«Ù‚ÙŠÙ„ØªØ§Ù† ÙÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ØŒ Ø­Ø¨ÙŠØ¨ØªØ§Ù† Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø­Ù…Ù†: Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø­Ù…Ø¯Ù‡ØŒ Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹Ø¸ÙŠÙ…"',
        book: 'ØµØ­ÙŠØ­ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ',
        englishNarrator: 'Ø£Ø¨Ùˆ Ù‡Ø±ÙŠØ±Ø© Ø±Ø¶ÙŠ Ø§Ù„Ù„Ù‡ Ø¹Ù†Ù‡',
        hadithNumber: '6406',
        chapter: 'ÙƒØªØ§Ø¨ Ø§Ù„Ø¯Ø¹ÙˆØ§Øª'
      };
      
      console.log('ğŸ“‹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø¯ÙŠØ« Ø§Ø­ØªÙŠØ§Ø·ÙŠ');
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¯ÙŠØ« Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
    console.log('ğŸ“§ Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¯ÙŠØ« Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†...');
    const results = await sendDailyHadithToAll(subscribers, hadith);

    const stats = {
      total: subscribers.length,
      successful: results.successful.length,
      failed: results.failed.length
    };

    console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', stats);

    if (results.failed.length > 0) {
      console.log('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€:', results.failed.map(f => f.email));
    }

    return res.status(200).json({ 
      ok: true, 
      message: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ${stats.successful} Ù…Ø´ØªØ±Ùƒ${stats.failed > 0 ? ` (ÙØ´Ù„: ${stats.failed})` : ''}`,
      stats,
      hadith: {
        text: hadith.hadithText?.substring(0, 150) + '...',
        source: hadith.book,
        narrator: hadith.englishNarrator
      }
    });

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ÙŠ:', error);
    return res.status(500).json({ 
      ok: false, 
      message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ÙŠ',
      error: error.message
    });
  }
}
